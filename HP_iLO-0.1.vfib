{"name":"HP iLO","type":"virtual_device","properties":{"deviceIcon":0,"currentIcon":"0","log":"","logTemp":"","mainLoop":"local selfId = fibaro:getSelfId()\n\nlocal HPiLO_Status = fibaro:getGlobal(\"HPiLO_Status\")\nlocal HPiLO_AmbientTemp = fibaro:getGlobal(\"HPiLO_AmbientTemp\")\nlocal HPiLO_CPUTemp = fibaro:getGlobal(\"HPiLO_CPUTemp\")\n\nfibaro:call(selfId, \"setProperty\", \"ui.Status.value\", HPiLO_Status)\nfibaro:call(selfId, \"setProperty\", \"ui.AmbientTemp.value\", HPiLO_AmbientTemp)\nfibaro:call(selfId, \"setProperty\", \"ui.CPUTemp.value\", HPiLO_CPUTemp)\n     \t \nfibaro:sleep(60*1000) --sleep 60s","ui.AmbientTemp.value":"23","ui.CPUTemp.value":"40","ui.Status.value":"On","visible":"true","rows":[{"type":"label","elements":[{"id":1,"lua":false,"waitForResponse":false,"caption":"Etat","name":"Status","favourite":false,"main":false}]},{"type":"label","elements":[{"id":2,"lua":false,"waitForResponse":false,"caption":"T° Ambiante","name":"AmbientTemp","favourite":false,"main":false}]},{"type":"label","elements":[{"id":3,"lua":false,"waitForResponse":false,"caption":"T° CPU","name":"CPUTemp","favourite":false,"main":false}]},{"type":"button","elements":[{"id":4,"lua":true,"waitForResponse":false,"caption":"Refresh","name":"Poll","empty":false,"msg":"if not iLoObject then iLoObject = {\n  _userId = 2,-- User ID used for notifications\n  _polling = 300,-- Polling time (value in seconds)\n  _trace = true,-- Enable / Disable debug mode\n  _notifications = {\n      missedCalls = true, -- Enable/Disable missed calls email notification\n      newFirmwareInstaled = true\n  },\n  _wifiDevice = {\n  },\n  _lanDevice = {\n  },\n  _host = \"192.168.1.1\",\n  _port = 443\n};iLo=iLoObject;end;\nif not VG then\n\tVG = {\n\t\t['p_iLo_appToken']   = {['default']=''       , ['enum']={}},\n\t\t['HPiLO_IP']             = {['default']=''       , ['enum']={}},\n\t\t['HPiLO_HddTemp']        = {['default']='0'      , ['enum']={}},\n\t\t['HPiLO_Status']           = {['default']='Inactif', ['enum']={\"On\",\"Off\"}},\n\t\t['HPiLO_CPUTemp']       = {['default']='0'      , ['enum']={}},\n\t\t['HPiLO_SysTemp']       = {['default']='0'      , ['enum']={}},\n\t\t['HPiLO_AmbientTemp']    = {['default']='0'      , ['enum']={}},\n\t\t['HPiLO_FanRPM']         = {['default']='0'      , ['enum']={}},\n\t\t['HPiLO_FwVersion']      = {['default']='0'      , ['enum']={}}\n\t}\n\tfunction CreateVG(varName, varValue, varEnum)\n\t\tlocal isEnum = (#varEnum > 0) and 1 or 0\n\t\tlocal HC2 = Net.FHttp(\"127.0.0.1\", 11111)\n\t\tlocal payload = '{\"name\":\"'..varName..'\",\"isEnum\":'..isEnum..',\"value\":\"'..(varValue or \"\")..'\"}'\n\t\tlocal response, status, errorCode = HC2:POST(\"/api/globalVariables/\"..varName, payload)\n\t\tif tonumber(errorCode) == 0 and (tonumber(status) == 200 or tonumber(status) == 201) and response ~= nil and response ~= \"\" then\n\t\t\tfibaro:debug('Global variable \"'..varName..'\" created')\n\t\t\tif isEnum > 0 then\n\t\t\t\tlocal payload = '{\"name\":\"'..varName..'\",\"isEnum\":true,\"enumValues\":'..json.encode(varEnum)..'}'\n\t\t\t\tlocal response, status, errorCode = HC2:PUT(\"/api/globalVariables/\"..varName, payload)\n\t\t\t\tif tonumber(errorCode) == 0 and (tonumber(status) == 200 or tonumber(status) == 201) and response ~= nil and response ~= \"\" then\n\t\t\t\t\tfibaro:debug('Global variable \"'..varName..'\" modified with enum values')\n\t\t\t\telse\n\t\t\t\t\tfibaro:debug('<span style=\"display:inline;color:red;\">Error : Can not modify enum global variable, errorCode='..errorCode..', status='..status..', payload='..payload..', response='..(response or \"\")..'</span>')\n\t\t\t\tend\n\t\t\tend\n\t\telse\n\t\t\tfibaro:debug('<span style=\"display:inline;color:red;\">Error : Can not create global variable, errorCode='..errorCode..', status='..status..', payload='..payload..', response='..(response or \"\")..'</span>')\n\t\tend\n\t\tHC2 = nil\n\tend\n\tlocal HC2 = Net.FHttp(\"127.0.0.1\", 11111)\n\tfor vg, param in pairs(VG) do\n\t\tfibaro:debug(\"Check if global variable '\"..vg..\"' exists\")\n\t\tlocal response, status, errorCode = HC2:GET(\"/api/globalVariables/\"..vg)\n\t\tif tonumber(errorCode) == 0 and tonumber(status) == 200 and response ~= nil and response ~= \"\" then\n\t\t\tlocal jsonTable = json.decode(response)\n\t\t\tif not jsonTable.name or jsonTable.name ~= vg then\n\t\t\t\tfibaro:debug('Response OK but global variable \"'..vg..'\" does not exist...')\n\t\t\t\tCreateVG(vg, param['default'], param['enum'])\n\t\t\tend\n\t\telse\n\t\t\tfibaro:debug('Global variable \"'..vg..'\" does not exist...')\n\t\t\tCreateVG(vg, param['default'], param['enum'])\n\t\tend\n\tend\nend -- if not VG\n\n\n\nlocal selfId = fibaro:getSelfId()\nlocal HPiLO_Status = fibaro:getGlobal(\"HPiLO_Status\")\nlocal HPiLO_AmbientTemp = fibaro:getGlobal(\"HPiLO_AmbientTemp\")\nlocal HPiLO_CPUTemp = fibaro:getGlobal(\"HPiLO_CPUTemp\")\n\nfibaro:call(selfId, \"setProperty\", \"ui.Status.value\", HPiLO_Status)\nfibaro:call(selfId, \"setProperty\", \"ui.AmbientTemp.value\", HPiLO_AmbientTemp)\nfibaro:call(selfId, \"setProperty\", \"ui.CPUTemp.value\", HPiLO_CPUTemp)\n","buttonIcon":0,"favourite":false,"main":true}]}]},"actions":{"pressButton":1,"setSlider":2,"setProperty":2}}